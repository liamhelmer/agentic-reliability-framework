name: V3 Comprehensive Validation

on:
  workflow_dispatch:
    inputs:
      validation_level:
        description: 'Validation Level'
        required: true
        default: 'certification'
        type: choice
        options:
        - quick
        - comprehensive
        - certification

jobs:
  v3-validation:
    name: V3 Comprehensive Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install package in development mode
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -e .
        
    - name: List installed packages
      run: |
        echo "=== INSTALLED PACKAGES ==="
        pip list | grep -E "agentic|Package"
    
    - name: Run quick V3 test
      run: |
        echo "=== QUICK V3 TEST ==="
        python scripts/test_v3_quick.py
    
    - name: Run check_v3_status.py
      run: |
        echo "=== RUNNING check_v3_status.py ==="
        python scripts/check_v3_status.py || echo "⚠️ check_v3_status.py failed (continuing...)"
    
    - name: Run enhanced V3 boundary check (if comprehensive or certification)
      if: ${{ inputs.validation_level == 'comprehensive' || inputs.validation_level == 'certification' }}
      run: |
        echo "=== RUNNING enhanced_v3_boundary_check.py ==="
        python scripts/enhanced_v3_boundary_check.py || echo "⚠️ enhanced_v3_boundary_check.py failed (continuing...)"
    
    - name: Run comprehensive V3 validation (if certification)
      if: ${{ inputs.validation_level == 'certification' }}
      run: |
        echo "=== RUNNING run_v3_validation.py --certify ==="
        python scripts/run_v3_validation.py --certify || echo "⚠️ run_v3_validation.py failed (continuing...)"
    
    - name: Check generated files
      if: ${{ inputs.validation_level == 'certification' }}
      run: |
        echo "=== CHECKING GENERATED FILES ==="
        echo "Current directory: $(pwd)"
        echo ""
        echo "All JSON files:"
        find . -name "*.json" -type f 2>/dev/null | grep -v node_modules | sort || echo "No JSON files found"
        
        echo ""
        echo "Specifically looking for V3 files:"
        if [ -f "V3_COMPLIANCE_CERTIFICATION.json" ]; then
          echo "✅ V3_COMPLIANCE_CERTIFICATION.json FOUND"
          echo "File size: $(wc -l < V3_COMPLIANCE_CERTIFICATION.json) lines"
          echo "First 3 lines:"
          head -3 V3_COMPLIANCE_CERTIFICATION.json
        else
          echo "❌ V3_COMPLIANCE_CERTIFICATION.json NOT FOUND"
          echo "Trying to create it..."
          python -c "
          import json
          data = {
              'status': 'MANUALLY_CREATED',
              'message': 'Certification file was not generated by validation',
              'next_step': 'Run: python scripts/run_v3_validation.py --certify'
          }
          with open('V3_COMPLIANCE_CERTIFICATION.json', 'w') as f:
              json.dump(data, f, indent=2)
          print('Created placeholder certification file')
          "
        fi
        
        echo ""
        if [ -f "V3_COMPLIANCE_ISSUES.json" ]; then
          echo "⚠️  V3_COMPLIANCE_ISSUES.json FOUND"
          echo "File size: $(wc -l < V3_COMPLIANCE_ISSUES.json) lines"
          echo "First 3 lines:"
          head -3 V3_COMPLIANCE_ISSUES.json
        fi
    
    - name: Upload artifacts (if any V3 files exist)
      if: ${{ always() && inputs.validation_level == 'certification' }}
      uses: actions/upload-artifact@v4
      with:
        name: v3-validation-artifacts
        path: |
          V3_COMPLIANCE_CERTIFICATION.json
          V3_COMPLIANCE_ISSUES.json
        if-no-files-found: warn
        retention-days: 30
