# .github/workflows/oss_tests.yml - WORKING VERSION
name: OSS Boundary Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  oss-boundary:
    name: OSS Boundary Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
      
    - name: OSS Boundary Validation
      run: |
        echo "ðŸ” OSS BOUNDARY VALIDATION"
        echo "=========================="
        
        # Check 1: Required directories exist
        echo ""
        echo "1. Checking required directories..."
        if [ -d "agentic_reliability_framework" ] && [ -d "agentic_reliability_framework/arf_core" ] && [ -d "agentic_reliability_framework/arf_core/models" ] && [ -d "agentic_reliability_framework/arf_core/engine" ] && [ -d "agentic_reliability_framework/arf_core/config" ]; then
          echo "âœ… All required directories exist"
        else
          echo "âŒ Missing required OSS directories"
          exit 1
        fi
        
        # Check 2: Required files exist
        echo ""
        echo "2. Checking required files..."
        if [ -f "agentic_reliability_framework/__init__.py" ] && [ -f "agentic_reliability_framework/arf_core/__init__.py" ] && [ -f "agentic_reliability_framework/arf_core/constants.py" ] && [ -f "agentic_reliability_framework/arf_core/models/healing_intent.py" ]; then
          echo "âœ… All required files exist"
        else
          echo "âŒ Missing required OSS files"
          exit 1
        fi
        
        # Check 3: Simple Enterprise code check
        echo ""
        echo "3. Checking for Enterprise code violations..."
        VIOLATIONS=$(grep -r "EnterpriseMCPServer\|enterprise_mcp_server" agentic_reliability_framework/arf_core/ --include="*.py" | grep -v "#" | grep -v "'" | grep -v '"' | wc -l)
        
        if [ "$VIOLATIONS" -gt 0 ]; then
          echo "âŒ Found $VIOLATIONS Enterprise code violations"
          grep -r "EnterpriseMCPServer\|enterprise_mcp_server" agentic_reliability_framework/arf_core/ --include="*.py" | grep -v "#" | grep -v "'" | grep -v '"'
          exit 1
        else
          echo "âœ… No Enterprise code violations found"
        fi
        
        # Check 4: Can import basic OSS module
        echo ""
        echo "4. Testing basic OSS imports..."
        
        # Create a simple Python test script
        cat > /tmp/test_imports.py << 'EOF'
import sys
try:
    import agentic_reliability_framework as arf
    print('   âœ… Successfully imported agentic_reliability_framework')
    print(f'   Version: {arf.__version__}')
    
    from agentic_reliability_framework.arf_core import constants
    print(f'   âœ… OSS constants: {constants.OSS_EDITION}')
    print(f'   License: {constants.OSS_LICENSE}')
    
    from agentic_reliability_framework.arf_core.models import healing_intent
    print('   âœ… OSS healing_intent module available')
    
    from agentic_reliability_framework.arf_core.engine.simple_mcp_client import OSSMCPClient
    print('   âœ… OSS MCP client available')
    
    print('')
    print('ðŸŽ‰ All OSS imports working correctly!')
    
except ImportError as e:
    print(f'   âŒ Import failed: {e}')
    import traceback
    traceback.print_exc()
    sys.exit(1)
except Exception as e:
    print(f'   âš ï¸  Other error: {e}')
    import traceback
    traceback.print_exc()
    sys.exit(1)
EOF
        
        python3 /tmp/test_imports.py
        
        echo ""
        echo "=========================================="
        echo "ðŸŽ‰ OSS BOUNDARY VALIDATION PASSED!"
        echo "=========================================="
        echo "âœ“ All required directories exist"
        echo "âœ“ All required files exist"
        echo "âœ“ No Enterprise code violations"
        echo "âœ“ All OSS imports work correctly"
        echo "âœ“ OSS edition is clean and functional"
