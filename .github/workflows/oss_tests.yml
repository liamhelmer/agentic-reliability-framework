# .github/workflows/oss_tests.yml
name: OSS Boundary Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'agentic_reliability_framework/arf_core/**'
      - 'scripts/**'
      - '.github/workflows/oss_tests.yml'

jobs:
  oss-boundary:
    name: OSS Boundary Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Run super simple OSS check
      run: |
        echo "üîç SUPER SIMPLE OSS CHECK"
        echo "========================"
        
        # 1. Check if arf_core exists
        if [ -d "agentic_reliability_framework/arf_core" ]; then
          echo "‚úÖ arf_core directory exists"
        else
          echo "‚ùå arf_core directory missing - creating it"
          mkdir -p agentic_reliability_framework/arf_core
        fi
        
        # 2. Ensure critical files exist
        echo ""
        echo "Ensuring critical files:"
        
        # Create __init__.py if missing
        INIT_FILE="agentic_reliability_framework/arf_core/__init__.py"
        if [ ! -f "$INIT_FILE" ]; then
          echo "   Creating $INIT_FILE"
          echo "# OSS Core Package" > "$INIT_FILE"
          echo "__version__ = '3.3.0'" >> "$INIT_FILE"
          echo "__all__ = ['constants', 'models', 'engine']" >> "$INIT_FILE"
        else
          echo "   ‚úÖ __init__.py exists"
        fi
        
        # Check constants.py exists
        CONSTANTS_FILE="agentic_reliability_framework/arf_core/constants.py"
        if [ -f "$CONSTANTS_FILE" ]; then
          echo "   ‚úÖ constants.py exists"
          
          # Quick check for OSS values
          if grep -q "advisory" "$CONSTANTS_FILE"; then
            echo "   ‚úÖ Contains 'advisory'"
          else
            echo "   ‚ö†Ô∏è  Missing 'advisory' keyword"
          fi
        else
          echo "   ‚ùå constants.py missing"
          exit 1
        fi
        
        # 3. Check for ABSOLUTE NO-NO Enterprise patterns
        echo ""
        echo "Checking for absolute no-nos:"
        
        ABSOLUTE_NO_NOS=(
          "EnterpriseMCPServer"
          "LicenseManager"
          "ARF-ENT-"
        )
        
        found_problems=0
        for pattern in "${ABSOLUTE_NO_NOS[@]}"; do
          echo "   Checking for: $pattern"
          if grep -r "$pattern" agentic_reliability_framework/arf_core/ --include="*.py" 2>/dev/null; then
            echo "   ‚ùå Found: $pattern"
            found_problems=1
          fi
        done
        
        if [ $found_problems -eq 0 ]; then
          echo "   ‚úÖ No absolute no-nos found"
        else
          echo "‚ùå Found absolute no-nos - failing build"
          exit 1
        fi
        
        # 4. Success!
        echo ""
        echo "üéâ OSS BOUNDARY CHECK PASSED!"
        echo ""
        echo "Note: This is a minimal check to ensure no Enterprise code"
        echo "has leaked into the OSS package. The main functionality"
        echo "is tested in the comprehensive tests workflow."
